<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UX Spec Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      line-height: 1.4;
      background: #f8f9fa;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
    
    .mode-selector {
      display: flex;
      border-bottom: 1px solid #e9ecef;
    }
    
    .mode-tab {
      flex: 1;
      padding: 12px;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .mode-tab:hover {
      background: #e9ecef;
    }
    
    .mode-tab.active {
      background: white;
      color: #667eea;
      border-bottom: 2px solid #667eea;
    }
    
    .content {
      padding: 16px;
    }
    
    .mode-content {
      min-height: 300px;
    }
    
    .hidden {
      display: none;
    }
    
    /* Mode √©cran individuel */
    .selection-info {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #28a745;
    }
    
    /* Mode projet complet */
    .step {
      margin-bottom: 20px;
    }
    
    .project-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .stat {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    
    .stat .number {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
    }
    
    .stat .label {
      font-size: 10px;
      color: #6c757d;
      margin-top: 4px;
    }
    
    .question-block {
      margin-bottom: 16px;
    }
    
    .question-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #2d3748;
    }
    
    .question-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 11px;
    }
    
    textarea.question-input {
      resize: vertical;
      min-height: 60px;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .progress-container {
      margin: 16px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      width: 0%;
      transition: width 0.4s ease;
    }
    
    .progress-text {
      text-align: center;
      font-size: 11px;
      color: #6c757d;
    }
    
    .analysis-steps {
      margin-top: 16px;
    }
    
    .step-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0.5;
      transition: all 0.3s;
    }
    
    .step-item.active {
      background: #d4edda;
      color: #155724;
      opacity: 1;
    }
    
    .results-summary {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .result-item {
      margin-bottom: 6px;
      font-size: 11px;
      color: #155724;
    }
    
    .result-item:last-child {
      margin-bottom: 0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-buttons .btn {
      width: auto;
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ UX Spec Generator</h1>
    </div>
    
    <div class="mode-selector">
      <button class="mode-tab active" data-mode="single">üìÑ √âcran individuel</button>
      <button class="mode-tab" data-mode="project">üìÇ Projet complet</button>
      <button class="mode-tab" data-mode="config">‚öôÔ∏è Config</button>
    </div>
    
    <div class="content">
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE √âCRAN INDIVIDUEL -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="single-mode" class="mode-content">
        <div class="selection-info">
          <div><strong>üìå S√©lection :</strong> <span id="selection-status">S√©lectionnez une frame</span></div>
        </div>
        
        <button id="generate-single-spec" class="btn btn-primary" disabled>
          üìù G√©n√©rer spec UX
        </button>
        
        <div id="single-progress" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <div class="progress-text">G√©n√©ration en cours...</div>
        </div>
      </div>
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE PROJET COMPLET -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="project-mode" class="mode-content hidden">
        
        <!-- √âtape 1: Scan du projet -->
        <div id="project-scan" class="step">
          <div class="project-stats">
            <div class="stat">
              <span class="number" id="total-screens">-</span>
              <span class="label">√âcrans</span>
            </div>
            <div class="stat">
              <span class="number" id="total-pages">-</span>
              <span class="label">Pages</span>
            </div>
          </div>
          
          <button id="scan-project" class="btn btn-secondary">
            üîç Scanner le projet
          </button>
        </div>
        
        <!-- √âtape 2: Questions contextuelles -->
        <div id="project-questions" class="step hidden">
          <h3 style="margin-top: 0; font-size: 13px;">ü§î Questions contextuelles</h3>
          
          <div class="question-block">
            <label class="question-label">üéØ Objectif principal de ce projet ?</label>
            <textarea id="project-objective" class="question-input" 
              placeholder="Ex: Cr√©er une app mobile pour la gestion des commandes clients, Automatiser le processus de facturation..."></textarea>
          </div>
          
          <div class="question-block">
            <label class="question-label">üë• Utilisateurs principaux ?</label>
            <input type="text" id="target-users" class="question-input" 
              placeholder="Ex: Clients finaux, √âquipe commerciale, Administrateurs...">
          </div>
          
          <div class="question-block">
            <label class="question-label">üè¢ Type de projet</label>
            <select id="project-type" class="question-input">
              <option value="client-external">Pour clients externes</option>
              <option value="internal-product">Produit interne</option>
              <option value="internal-tool">Outil interne d'√©quipe</option>
            </select>
          </div>
          
          <div class="question-block">
            <label class="question-label">üìã Niveau de documentation</label>
            <select id="detail-level" class="question-input">
              <option value="complete">Sp√©cifications compl√®tes (User Stories + crit√®res)</option>
              <option value="overview">Vue d'ensemble (Epics + Features)</option>
            </select>
          </div>
          
          <div class="question-block">
            <label class="question-label">üîó Int√©grations n√©cessaires ?</label>
            <input type="text" id="integrations" class="question-input" 
              placeholder="Ex: API de paiement, CRM, Base de donn√©es clients...">
          </div>
          
          <button id="start-analysis" class="btn btn-primary">
            üöÄ Lancer l'analyse compl√®te
          </button>
        </div>
        
        <!-- √âtape 3: Analyse en cours -->
        <div id="project-analysis" class="step hidden">
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="analysis-progress"></div>
            </div>
            <div class="progress-text" id="analysis-status">Analyse contextuelle en cours...</div>
          </div>
          
          <div class="analysis-steps">
            <div class="step-item" id="step-extract">üì∏ Extraction des √©crans</div>
            <div class="step-item" id="step-analyze">üß† Analyse IA contextuelle</div>
            <div class="step-item" id="step-structure">üèóÔ∏è G√©n√©ration structure PM/PO</div>
            <div class="step-item" id="step-tuleap">üìã Cr√©ation dans Tuleap</div>
          </div>
        </div>
        
        <!-- √âtape 4: R√©sultats -->
        <div id="project-results" class="step hidden">
          <h3 style="margin-top: 0;">‚úÖ Analyse termin√©e !</h3>
          
          <div class="results-summary">
            <div class="result-item">
              <strong>üìä √âpics cr√©√©s :</strong> <span id="epics-count">0</span>
            </div>
            <div class="result-item">
              <strong>üîß Features :</strong> <span id="features-count">0</span>
            </div>
            <div class="result-item">
              <strong>üìù User Stories :</strong> <span id="stories-count">0</span>
            </div>
            <div class="result-item">
              <strong>‚è±Ô∏è Dur√©e :</strong> <span id="analysis-duration">-</span>
            </div>
          </div>
          
          <div class="action-buttons">
            <button id="view-tuleap" class="btn btn-primary">üìã Voir dans Tuleap</button>
            <button id="restart-analysis" class="btn btn-secondary">üîÑ Nouvelle analyse</button>
          </div>
        </div>
        
      </div>
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE CONFIGURATION -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="config-mode" class="mode-content hidden">
        <h2>‚öôÔ∏è Configuration</h2>
        
        <div class="config-section">
          <h3>üîç MCP (Modular Code Processor)</h3>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="mcp-enabled" checked>
              Activer l'int√©gration MCP
            </label>
          </div>
          
          <div class="form-group">
            <label for="mcp-url">URL du serveur MCP:</label>
            <input type="text" id="mcp-url" class="form-control" value="http://localhost:3000/mcp">
          </div>
          
          <div class="form-group">
            <label for="mcp-timeout">Timeout (ms):</label>
            <input type="number" id="mcp-timeout" class="form-control" value="60000" min="5000" step="1000">
          </div>
          
          <button id="test-mcp-connection" class="btn btn-secondary">üîç Tester la connexion MCP</button>
          <div id="mcp-test-result" class="mt-2"></div>
        </div>
        
        <div class="config-section">
          <h3>üì∑ Cloudinary (optionnel)</h3>
          
          <div class="form-group">
            <label for="cloudinary-cloud">Cloud Name:</label>
            <input type="text" id="cloudinary-cloud" class="form-control" placeholder="votre_cloud_name">
          </div>
          
          <div class="form-group">
            <label for="cloudinary-preset">Upload Preset:</label>
            <input type="text" id="cloudinary-preset" class="form-control" placeholder="votre_upload_preset">
          </div>
        </div>
        
        <button id="save-config" class="btn btn-primary mt-3">üíæ Sauvegarder la configuration</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GESTION DE L'INTERFACE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let currentMode = 'single';
    let projectData = null;
    
    // Charger la configuration sauvegard√©e
    function loadSavedConfig() {
      try {
        // Charger la configuration MCP
        const savedMcpConfig = localStorage.getItem('mcpConfig');
        if (savedMcpConfig) {
          const parsedConfig = JSON.parse(savedMcpConfig);
          
          // Mettre √† jour la configuration MCP
          mcpConfig.server_url = parsedConfig.server_url || mcpConfig.server_url;
          mcpConfig.timeout = parsedConfig.timeout || mcpConfig.timeout;
          mcpConfig.enabled = parsedConfig.enabled !== undefined ? parsedConfig.enabled : true;
          
          // Mettre √† jour l'interface
          document.getElementById('mcp-enabled').checked = mcpConfig.enabled;
          document.getElementById('mcp-url').value = mcpConfig.server_url;
          document.getElementById('mcp-timeout').value = mcpConfig.timeout;
        }
        
        // Charger la configuration Cloudinary
        const cloudName = localStorage.getItem('cloudinary-cloud');
        const uploadPreset = localStorage.getItem('cloudinary-preset');
        
        if (cloudName) document.getElementById('cloudinary-cloud').value = cloudName;
        if (uploadPreset) document.getElementById('cloudinary-preset').value = uploadPreset;
        
      } catch (error) {
        console.error('Erreur chargement config:', error);
      }
    }
    
    // Gestion des onglets
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        switchMode(mode);
      });
    });
    
    function switchMode(mode) {
      currentMode = mode;
      
      // Mise √† jour des onglets
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      
      // Affichage du contenu
      document.querySelectorAll('.mode-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${mode}-mode`).classList.remove('hidden');
      
      // Initialisation du mode
      if (mode === 'single') {
        initSingleMode();
      } else if (mode === 'project') {
        initProjectMode();
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODE √âCRAN INDIVIDUEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function initSingleMode() {
      updateSelectionStatus();
    }
    
    function updateSelectionStatus(selection) {
      const selectionStatus = document.getElementById('selection-status');
      const generateButton = document.getElementById('generate-single-spec');
      
      if (selection && selection.length === 1 && selection[0].type === 'FRAME') {
        // Une frame est s√©lectionn√©e
        selectionStatus.textContent = `Frame: ${selection[0].name}`;
        selectionStatus.classList.add('valid-selection');
        selectionStatus.classList.remove('invalid-selection');
        generateButton.disabled = false;
      } else if (selection && selection.length === 1) {
        // Un √©l√©ment est s√©lectionn√© mais ce n'est pas une frame
        selectionStatus.textContent = `S√©lection invalide: ${selection[0].type}`;
        selectionStatus.classList.add('invalid-selection');
        selectionStatus.classList.remove('valid-selection');
        generateButton.disabled = true;
      } else if (selection && selection.length > 1) {
        // Plusieurs √©l√©ments s√©lectionn√©s
        selectionStatus.textContent = `${selection.length} √©l√©ments s√©lectionn√©s. S√©lectionnez une seule frame.`;
        selectionStatus.classList.add('invalid-selection');
        selectionStatus.classList.remove('valid-selection');
        generateButton.disabled = true;
      } else {
        // Aucune s√©lection
        selectionStatus.textContent = 'S√©lectionnez une frame';
        selectionStatus.classList.remove('valid-selection');
        selectionStatus.classList.remove('invalid-selection');
        generateButton.disabled = true;
      }
    }
    
    document.getElementById('generate-single-spec').addEventListener('click', () => {
      showSingleProgress();
      parent.postMessage({ 
        pluginMessage: { type: 'generate-single-spec' } 
      }, '*');
    });
    
    function showSingleProgress() {
      document.getElementById('single-progress').classList.remove('hidden');
      document.getElementById('generate-single-spec').disabled = true;
      
      // Simulation progression
      const progressFill = document.querySelector('#single-progress .progress-fill');
      let progress = 0;
      const interval = setInterval(() => {
        progress += 20;
        progressFill.style.width = progress + '%';
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('single-progress').classList.add('hidden');
            document.getElementById('generate-single-spec').disabled = false;
          }, 1000);
        }
      }, 500);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODE PROJET COMPLET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function initProjectMode() {
      resetProjectMode();
    }
    
    function resetProjectMode() {
      // R√©initialisation de l'interface
      document.getElementById('project-scan').classList.remove('hidden');
      document.getElementById('project-questions').classList.add('hidden');
      document.getElementById('project-analysis').classList.add('hidden');
      document.getElementById('project-results').classList.add('hidden');
      
      // Reset des stats
      document.getElementById('total-screens').textContent = '-';
      document.getElementById('total-pages').textContent = '-';
    }
    
    document.getElementById('scan-project').addEventListener('click', () => {
      document.getElementById('scan-project').disabled = true;
      document.getElementById('scan-project').textContent = 'üîç Scan en cours...';
      
      parent.postMessage({ 
        pluginMessage: { type: 'scan-project' } 
      }, '*');
    });
    
    document.getElementById('start-analysis').addEventListener('click', () => {
      // Validation des champs
      const objective = document.getElementById('project-objective').value.trim();
      const users = document.getElementById('target-users').value.trim();
      
      if (!objective || !users) {
        alert('Veuillez remplir au moins l\'objectif et les utilisateurs');
        return;
      }
      
      // Collecte du contexte
      const context = {
        project_objective: objective,
        target_users: users,
        project_type: document.getElementById('project-type').value,
        detail_level: document.getElementById('detail-level').value,
        integrations: document.getElementById('integrations').value.trim()
      };
      
      // Transition vers analyse
      showAnalysisStep();
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'start-contextual-analysis',
          context: context
        } 
      }, '*');
    });
    
    function showProjectQuestions() {
      document.getElementById('project-scan').classList.add('hidden');
      document.getElementById('project-questions').classList.remove('hidden');
    }
    
    function showAnalysisStep() {
      document.getElementById('project-questions').classList.add('hidden');
      document.getElementById('project-analysis').classList.remove('hidden');
      
      // Animation des √©tapes
      const steps = ['step-extract', 'step-analyze', 'step-structure', 'step-tuleap'];
      let currentStep = 0;
      
      const interval = setInterval(() => {
        if (currentStep < steps.length) {
          document.getElementById(steps[currentStep]).classList.add('active');
          
          // Mise √† jour du texte de progression
          const statusTexts = [
            'Extraction des √©crans...',
            'Analyse IA contextuelle...',
            'G√©n√©ration structure PM/PO...',
            'Cr√©ation dans Tuleap...'
          ];
          document.getElementById('analysis-status').textContent = statusTexts[currentStep];
          
          // Progression de la barre
          const progress = ((currentStep + 1) / steps.length) * 100;
          document.getElementById('analysis-progress').style.width = progress + '%';
          
          currentStep++;
        } else {
          clearInterval(interval);
          document.getElementById('analysis-status').textContent = '‚úÖ Analyse termin√©e !';
        }
      }, 2000);
    }
    
    function showResults(data) {
      document.getElementById('project-analysis').classList.add('hidden');
      document.getElementById('project-results').classList.remove('hidden');
      
      // Mise √† jour des r√©sultats
      document.getElementById('epics-count').textContent = data.epics || '0';
      document.getElementById('features-count').textContent = data.features || '0';
      document.getElementById('stories-count').textContent = data.stories || '0';
      document.getElementById('analysis-duration').textContent = data.duration || '-';
    }
    
    document.getElementById('restart-analysis').addEventListener('click', () => {
      resetProjectMode();
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UPLOAD D'IMAGES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Fonction pour uploader une image vers Cloudinary
    async function uploadToCloudinary(base64Image, cloudName, uploadPreset) {
      try {
        // Pr√©parer les donn√©es pour l'upload
        const formData = new FormData();
        formData.append('file', `data:image/png;base64,${base64Image}`);
        formData.append('upload_preset', uploadPreset);
        formData.append('folder', 'figma-specs');
        
        // Faire la requ√™te vers Cloudinary
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`Upload failed: ${response.status}`);
        }
        
        const result = await response.json();
        return result.secure_url;
      } catch (error) {
        console.error('Erreur upload Cloudinary:', error);
        throw error;
      }
    }
    
    // Fonction de fallback pour uploader vers Imgur si Cloudinary √©choue
    async function uploadToImgur(base64Image, apiKey) {
      try {
        // Supprimer le pr√©fixe data:image/png;base64, si pr√©sent
        const imageData = base64Image.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');
        
        const response = await fetch('https://api.imgur.com/3/image', {
          method: 'POST',
          headers: {
            'Authorization': `Client-ID ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image: imageData,
            type: 'base64'
          })
        });
        
        if (!response.ok) {
          throw new Error(`Imgur upload failed: ${response.status}`);
        }
        
        const result = await response.json();
        return result.data.link;
      } catch (error) {
        console.error('Erreur upload Imgur:', error);
        throw error;
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CLIENT MCP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Configuration par d√©faut du client MCP
    const mcpConfig = {
      server_url: 'http://localhost:3000/mcp',
      timeout: 60000, // 60 secondes
      debug: true
    };
    
    // Fonction pour appeler le serveur MCP
    async function callMCPServer(tool, params) {
      console.log(`üîç Appel MCP: ${tool}`, params);
      console.log('üîç DEBUG UI - Appel MCP:');
console.log('- Tool:', tool);
console.log('- Params:', JSON.stringify(params, null, 2));
      try {
        // Construire l'URL de l'outil
        const url = `${mcpConfig.server_url}/${tool}`;
        
        // Logs de d√©bogage avant l'appel
        console.log('üîç DEBUG UI - Appel MCP:');
        console.log('- Tool:', tool);
        console.log('- Params:', JSON.stringify(params, null, 2));
        console.log('- URL:', url);
        
        // Appeler le serveur MCP
        const headers = {
          'Content-Type': 'application/json'
        };
        
        // N'ajouter l'en-t√™te Authorization que si un token est disponible
        if (mcpConfig.auth_token) {
          headers['Authorization'] = `Bearer ${mcpConfig.auth_token}`;
        }
        
        const response = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(params)
        });
        
        // Logs de d√©bogage apr√®s r√©ception de la r√©ponse
        console.log('üì• DEBUG UI - R√©ponse MCP:');
        console.log('- Status:', response.status);
        console.log('- Headers:', [...response.headers.entries()]);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.log('- Error body:', errorText);
          throw new Error(`Erreur MCP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ R√©ponse MCP (${tool}):`, data);
        return data;
      } catch (error) {
        console.error(`‚ùå Erreur MCP ${tool}:`, error);
        throw error;
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GESTION DES MESSAGES DU PLUGIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      // Activer le bouton si une frame est d√©j√† s√©lectionn√©e
      updateGenerateButton();
      
      // Charger la configuration sauvegard√©e
      loadSavedConfig();
      
      // Configurer les gestionnaires d'√©v√©nements pour la configuration
      setupConfigHandlers();
    });
    
    // Configuration des gestionnaires d'√©v√©nements pour la configuration
    function setupConfigHandlers() {
      // Tester la connexion MCP
      document.getElementById('test-mcp-connection').addEventListener('click', async () => {
        const testResult = document.getElementById('mcp-test-result');
        testResult.innerHTML = 'Test de connexion en cours...';
        testResult.className = 'mt-2 text-info';
        
        try {
          const url = document.getElementById('mcp-url').value;
          // S'assurer que l'URL se termine par /mcp pour acc√©der √† /mcp/ping
          const baseUrl = url.endsWith('/mcp') ? url : (url.endsWith('/') ? url + 'mcp' : url + '/mcp');
          const response = await fetch(`${baseUrl}/ping`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            const data = await response.json();
            testResult.innerHTML = `‚úÖ Connexion r√©ussie! Serveur MCP v${data.version || '1.0'}`;
            testResult.className = 'mt-2 text-success';
          } else {
            testResult.innerHTML = `‚ùå Erreur: ${response.status} ${response.statusText}`;
            testResult.className = 'mt-2 text-danger';
          }
        } catch (error) {
          testResult.innerHTML = `‚ùå Erreur de connexion: ${error.message}`;
          testResult.className = 'mt-2 text-danger';
        }
      });
      
      // Sauvegarder la configuration
      document.getElementById('save-config').addEventListener('click', () => {
        // R√©cup√©rer les valeurs
        const enabled = document.getElementById('mcp-enabled').checked;
        const serverUrl = document.getElementById('mcp-url').value;
        const timeout = parseInt(document.getElementById('mcp-timeout').value);
        const cloudName = document.getElementById('cloudinary-cloud').value;
        const uploadPreset = document.getElementById('cloudinary-preset').value;
        
        // Mettre √† jour la configuration MCP
        mcpConfig.enabled = enabled;
        mcpConfig.server_url = serverUrl;
        mcpConfig.timeout = timeout;
        
        // Sauvegarder dans le localStorage
        localStorage.setItem('mcpConfig', JSON.stringify(mcpConfig));
        localStorage.setItem('cloudinary-cloud', cloudName);
        localStorage.setItem('cloudinary-preset', uploadPreset);
        
        // Informer le plugin de la nouvelle configuration
        parent.postMessage({
          pluginMessage: {
            type: 'update-mcp-config',
            config: mcpConfig
          }
        }, '*');
        
        // Afficher un message de confirmation
        alert('Configuration sauvegard√©e avec succ√®s!');
      });
    }
    
    // Fonction pour mettre √† jour l'√©tat du bouton de g√©n√©ration en fonction de l'objectif du projet
    function updateGenerateButton() {
      const projectObjectiveElement = document.getElementById('project-objective');
      const generateButton = document.getElementById('start-analysis');
      
      // V√©rifier si les √©l√©ments existent avant d'y acc√©der
      if (!projectObjectiveElement || !generateButton) {
        return; // Sortir de la fonction si les √©l√©ments n'existent pas
      }
      
      const projectObjective = projectObjectiveElement.value.trim();
      
      if (projectObjective.length > 10) {
        generateButton.disabled = false;
        generateButton.classList.remove('btn-disabled');
        generateButton.classList.add('btn-primary');
      } else {
        generateButton.disabled = true;
        generateButton.classList.remove('btn-primary');
        generateButton.classList.add('btn-disabled');
      }
    }

    // Ajouter un √©couteur d'√©v√©nement pour le champ d'objectif du projet
    const projectObjectiveElement = document.getElementById('project-objective');
    if (projectObjectiveElement) {
      projectObjectiveElement.addEventListener('input', updateGenerateButton);
    }
    
    // Appeler la fonction une fois au chargement pour initialiser l'√©tat du bouton
    updateGenerateButton();
    
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      switch (msg.type) {
        case 'selection-changed':
          if (currentMode === 'single') {
            updateSelectionStatus(msg.selection);
          }
          break;

        case 'mcp-request':
          // Traiter la requ√™te MCP
          console.log('üîÑ Requ√™te MCP re√ßue:', msg.tool, msg.params);
          
          callMCPServer(msg.tool, msg.params)
            .then(result => {
              // Renvoyer le r√©sultat au plugin
              parent.postMessage({
                pluginMessage: {
                  type: 'mcp-response',
                  requestId: msg.requestId,
                  result: result
                }
              }, '*');
            })
            .catch(error => {
              console.error('‚ùå Erreur MCP:', error);
              // Renvoyer l'erreur au plugin
              parent.postMessage({
                pluginMessage: {
                  type: 'mcp-response',
                  requestId: msg.requestId,
                  error: error.message
                }
              }, '*');
            });
          break;
          
        case 'upload-image':
          // Afficher un message de progression
          showSingleProgress();
          
          // V√©rifier si les √©l√©ments Cloudinary existent
          const cloudNameElement = document.getElementById('cloudinary-cloud');
          const uploadPresetElement = document.getElementById('cloudinary-preset');
          
          // R√©cup√©rer les param√®tres de Cloudinary s'ils existent
          const cloudName = cloudNameElement ? cloudNameElement.value : '';
          const uploadPreset = uploadPresetElement ? uploadPresetElement.value : '';
          
          // Tenter l'upload vers Cloudinary seulement si configur√©
          if (cloudName && uploadPreset) {
            uploadToCloudinary(msg.imageData, cloudName, uploadPreset)
              .then(imageUrl => {
                // Informer le plugin que l'upload est termin√©
                parent.postMessage({
                  pluginMessage: {
                    type: 'upload-complete',
                    frameId: msg.frameId,
                    imageUrl: imageUrl
                  }
                }, '*');
              })
              .catch(error => {
                console.error('Erreur Cloudinary, tentative avec Imgur:', error);
                // Fallback vers Imgur
                return uploadToImgur(msg.imageData, '546c25a59c58ad7');
              })
              .then(imageUrl => {
                if (imageUrl) {
                  parent.postMessage({
                    pluginMessage: {
                      type: 'upload-complete',
                      frameId: msg.frameId,
                      imageUrl: imageUrl
                    }
                  }, '*');
                }
              })
              .catch(error => {
                console.error('Toutes les tentatives d\'upload ont √©chou√©:', error);
                parent.postMessage({
                  pluginMessage: {
                    type: 'upload-error',
                    frameId: msg.frameId,
                    error: error.message
                  }
                }, '*');
              });
          } else {
            // Utiliser directement Imgur si Cloudinary n'est pas configur√©
            uploadToImgur(msg.imageData, '546c25a59c58ad7')
              .then(imageUrl => {
                parent.postMessage({
                  pluginMessage: {
                    type: 'upload-complete',
                    frameId: msg.frameId,
                    imageUrl: imageUrl
                  }
                }, '*');
              })
              .catch(error => {
                console.error('Erreur upload Imgur:', error);
                parent.postMessage({
                  pluginMessage: {
                    type: 'upload-error',
                    frameId: msg.frameId,
                    error: error.message
                  }
                }, '*');
              });
          }
          break;
          
        case 'project-scanned':
          document.getElementById('scan-project').disabled = false;
          document.getElementById('scan-project').textContent = 'üîç Scanner le projet';
          
          // Mise √† jour des stats
          document.getElementById('total-screens').textContent = msg.data.total_screens;
          document.getElementById('total-pages').textContent = msg.data.total_pages;
          
          projectData = msg.data;
          showProjectQuestions();
          break;
          
        case 'analysis-started':
          // L'analyse a d√©marr√© c√¥t√© serveur
          break;
          
        case 'analysis-completed':
          showResults(msg.data);
          break;
          
        case 'single-success':
          // Success pour √©cran individuel
          break;
          
        case 'error':
          alert(`Erreur: ${msg.message}`);
          break;
      }
    });
    
    // Initialisation
    initSingleMode();
  </script>
</body>
</html>