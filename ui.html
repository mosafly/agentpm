<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UX Spec Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      line-height: 1.4;
      background: #f8f9fa;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
    
    .mode-selector {
      display: flex;
      border-bottom: 1px solid #e9ecef;
    }
    
    .mode-tab {
      flex: 1;
      padding: 12px;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .mode-tab:hover {
      background: #e9ecef;
    }
    
    .mode-tab.active {
      background: white;
      color: #667eea;
      border-bottom: 2px solid #667eea;
    }
    
    .content {
      padding: 16px;
    }
    
    .mode-content {
      min-height: 300px;
    }
    
    .hidden {
      display: none;
    }
    
    /* Mode √©cran individuel */
    .selection-info {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #28a745;
    }
    
    /* Mode projet complet */
    .step {
      margin-bottom: 20px;
    }
    
    .project-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .stat {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    
    .stat .number {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
    }
    
    .stat .label {
      font-size: 10px;
      color: #6c757d;
      margin-top: 4px;
    }
    
    .question-block {
      margin-bottom: 16px;
    }
    
    .question-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #2d3748;
    }
    
    .question-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 11px;
    }
    
    textarea.question-input {
      resize: vertical;
      min-height: 60px;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .progress-container {
      margin: 16px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      width: 0%;
      transition: width 0.4s ease;
    }
    
    .progress-text {
      text-align: center;
      font-size: 11px;
      color: #6c757d;
    }
    
    .analysis-steps {
      margin-top: 16px;
    }
    
    .step-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0.5;
      transition: all 0.3s;
    }
    
    .step-item.active {
      background: #d4edda;
      color: #155724;
      opacity: 1;
    }
    
    .results-summary {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .result-item {
      margin-bottom: 6px;
      font-size: 11px;
      color: #155724;
    }
    
    .result-item:last-child {
      margin-bottom: 0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-buttons .btn {
      width: auto;
      flex: 1;
    }
    
    /* Style pour les notifications */
    #notifications-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 300px;
    }
    
    .notification {
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease-out forwards;
      transition: opacity 0.3s ease-out;
    }
    
    .notification.success {
      background-color: #E9F7EF;
      border-left: 4px solid #2ECC71;
    }
    
    .notification.error {
      background-color: #FDEDEC;
      border-left: 4px solid #E74C3C;
    }
    
    .notification.info {
      background-color: #EBF5FB;
      border-left: 4px solid #3498DB;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ Agent PM</h1>
    </div>
    
    <div class="mode-selector">
      <button class="mode-tab active" data-mode="single">üìÑ √âcran individuel</button>
      <button class="mode-tab" data-mode="project">üìÇ Projet complet</button>
      <button class="mode-tab" data-mode="config">‚öôÔ∏è Config</button>
    </div>
    
    <div class="content">
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE √âCRAN INDIVIDUEL -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="single-mode" class="mode-content">
        <div class="selection-info">
          <div><strong>üìå S√©lection :</strong> <span id="selection-status">S√©lectionnez une frame</span></div>
        </div>
        
        <button id="generate-single-spec" class="btn btn-primary" disabled>
          üìù G√©n√©rer spec UX
        </button>
        
        <div id="single-progress" class="progress-container hidden">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <div class="progress-text">G√©n√©ration en cours...</div>
        </div>
      </div>
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE PROJET COMPLET -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="project-mode" class="mode-content hidden">
        
        <!-- √âtape 1: Scan du projet -->
        <div id="project-scan" class="step">
          <div class="project-stats">
            <div class="stat">
              <span class="number" id="total-screens">-</span>
              <span class="label">√âcrans</span>
            </div>
            <div class="stat">
              <span class="number" id="total-pages">-</span>
              <span class="label">Pages</span>
            </div>
          </div>
          
          <button id="scan-project" class="btn btn-secondary">
            üîç Scanner le projet
          </button>
        </div>
        
        <!-- √âtape 2: Questions contextuelles -->
        <div id="project-questions" class="step hidden">
          <h3 style="margin-top: 0; font-size: 13px;">ü§î Questions contextuelles</h3>
          
          <div class="question-block">
            <label class="question-label">üéØ Objectif principal de ce projet ?</label>
            <textarea id="project-objective" class="question-input" 
              placeholder="Ex: Cr√©er une app mobile pour la gestion des commandes clients, Automatiser le processus de facturation..."></textarea>
          </div>
          
          <div class="question-block">
            <label class="question-label">üë• Utilisateurs principaux ?</label>
            <input type="text" id="target-users" class="question-input" 
              placeholder="Ex: Clients finaux, √âquipe commerciale, Administrateurs...">
          </div>
          
          <div class="question-block">
            <label class="question-label">üè¢ Type de projet</label>
            <select id="project-type" class="question-input">
              <option value="client-external">Pour clients externes</option>
              <option value="internal-product">Produit interne</option>
              <option value="internal-tool">Outil interne d'√©quipe</option>
            </select>
          </div>
          
          <div class="question-block">
            <label class="question-label">üìã Niveau de documentation</label>
            <select id="detail-level" class="question-input">
              <option value="complete">Sp√©cifications compl√®tes (User Stories + crit√®res)</option>
              <option value="overview">Vue d'ensemble (Epics + Features)</option>
            </select>
          </div>
          
          <div class="question-block">
            <label class="question-label">üîó Int√©grations n√©cessaires ?</label>
            <input type="text" id="integrations" class="question-input" 
              placeholder="Ex: API de paiement, CRM, Base de donn√©es clients...">
          </div>
          
          <button id="start-analysis" class="btn btn-primary">
            üöÄ Lancer l'analyse compl√®te
          </button>
        </div>
        
        <!-- √âtape 3: Analyse en cours -->
        <div id="project-analysis" class="step hidden">
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="analysis-progress"></div>
            </div>
            <div class="progress-text" id="analysis-status">Analyse contextuelle en cours...</div>
          </div>
          
          <div class="analysis-steps">
            <div class="step-item" id="step-extract">üì∏ Extraction des √©crans</div>
            <div class="step-item" id="step-analyze">üß† Analyse IA contextuelle</div>
            <div class="step-item" id="step-structure">üèóÔ∏è G√©n√©ration structure PM/PO</div>
            <div class="step-item" id="step-tuleap">üìã Cr√©ation dans Tuleap</div>
          </div>
        </div>
        
        <!-- √âtape 4: R√©sultats -->
        <div id="project-results" class="step hidden">
          <h3 style="margin-top: 0;">‚úÖ Analyse termin√©e !</h3>
          
          <div class="results-summary">
            <div class="result-item">
              <strong>üìä √âpics cr√©√©s :</strong> <span id="epics-count">0</span>
            </div>
            <div class="result-item">
              <strong>üîß Features :</strong> <span id="features-count">0</span>
            </div>
            <div class="result-item">
              <strong>üìù User Stories :</strong> <span id="stories-count">0</span>
            </div>
            <div class="result-item">
              <strong>‚è±Ô∏è Dur√©e :</strong> <span id="analysis-duration">-</span>
            </div>
          </div>
          
          <div class="action-buttons">
            <button id="view-tuleap" class="btn btn-primary">üìã Voir dans Tuleap</button>
            <button id="restart-analysis" class="btn btn-secondary">üîÑ Nouvelle analyse</button>
          </div>
        </div>
        
      </div>
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- MODE CONFIGURATION -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="config-mode" class="mode-content hidden">
        <h2>‚öôÔ∏è Configuration</h2>
        
        <div class="config-section">
          <h3>üîç MCP (Modular Code Processor)</h3>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="mcp-enabled" checked>
              Activer l'int√©gration MCP
            </label>
          </div>
          
          <div class="form-group">
            <label for="mcp-url">URL du serveur MCP:</label>
            <input type="text" id="mcp-url" class="form-control" value="http://localhost:3000/mcp">
          </div>
          
          <div class="form-group">
            <label for="mcp-timeout">Timeout (ms):</label>
            <input type="number" id="mcp-timeout" class="form-control" value="60000" min="5000" step="1000">
          </div>
          
          <button id="test-mcp-connection" class="btn btn-secondary">üîç Tester la connexion MCP</button>
          <div id="mcp-test-result" class="mt-2"></div>
        </div>
        
        <div class="config-section">
          <h3>üì∑ Cloudinary (optionnel)</h3>
          
          <div class="form-group">
            <label for="cloudinary-cloud">Cloud Name:</label>
            <input type="text" id="cloudinary-cloud" class="form-control" placeholder="votre_cloud_name">
          </div>
          
          <div class="form-group">
            <label for="cloudinary-preset">Upload Preset:</label>
            <input type="text" id="cloudinary-preset" class="form-control" placeholder="votre_upload_preset">
          </div>
        </div>
        
        <button id="save-config" class="btn btn-primary mt-3">üíæ Sauvegarder la configuration</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GESTION DE L'INTERFACE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let currentMode = 'single';
    let projectData = null;
    
    // Charger la configuration sauvegard√©e
    function loadSavedConfig() {
      try {
        // Charger la configuration MCP
        const savedMcpConfig = localStorage.getItem('mcpConfig');
        if (savedMcpConfig) {
          const parsedConfig = JSON.parse(savedMcpConfig);
          
          // Mettre √† jour la configuration MCP
          mcpConfig.server_url = parsedConfig.server_url || mcpConfig.server_url;
          mcpConfig.timeout = parsedConfig.timeout || mcpConfig.timeout;
          mcpConfig.enabled = parsedConfig.enabled !== undefined ? parsedConfig.enabled : true;
          
          // Mettre √† jour l'interface
          document.getElementById('mcp-enabled').checked = mcpConfig.enabled;
          document.getElementById('mcp-url').value = mcpConfig.server_url;
          document.getElementById('mcp-timeout').value = mcpConfig.timeout;
        }
        
        // Charger la configuration Cloudinary
        const cloudName = localStorage.getItem('cloudinary-cloud');
        const uploadPreset = localStorage.getItem('cloudinary-preset');
        
        if (cloudName) document.getElementById('cloudinary-cloud').value = cloudName;
        if (uploadPreset) document.getElementById('cloudinary-preset').value = uploadPreset;
        
      } catch (error) {
        console.error('Erreur chargement config:', error);
      }
    }
    
    // Gestion des onglets
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        switchMode(mode);
      });
    });
    
    function switchMode(mode) {
      currentMode = mode;
      
      // Mise √† jour des onglets
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      
      // Affichage du contenu
      document.querySelectorAll('.mode-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${mode}-mode`).classList.remove('hidden');
      
      // Initialisation du mode
      if (mode === 'single') {
        initSingleMode();
      } else if (mode === 'project') {
        initProjectMode();
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODE √âCRAN INDIVIDUEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function initSingleMode() {
      updateSelectionStatus();
    }
    
    function updateSelectionStatus(selection) {
      const selectionStatus = document.getElementById('selection-status');
      const generateButton = document.getElementById('generate-single-spec');
      
      if (selection && selection.length === 1 && selection[0].type === 'FRAME') {
        // Une frame est s√©lectionn√©e
        selectionStatus.textContent = `Frame: ${selection[0].name}`;
        selectionStatus.classList.add('valid-selection');
        selectionStatus.classList.remove('invalid-selection');
        generateButton.disabled = false;
      } else if (selection && selection.length === 1) {
        // Un √©l√©ment est s√©lectionn√© mais ce n'est pas une frame
        selectionStatus.textContent = `S√©lection invalide: ${selection[0].type}`;
        selectionStatus.classList.add('invalid-selection');
        selectionStatus.classList.remove('valid-selection');
        generateButton.disabled = true;
      } else if (selection && selection.length > 1) {
        // Plusieurs √©l√©ments s√©lectionn√©s
        selectionStatus.textContent = `${selection.length} √©l√©ments s√©lectionn√©s. S√©lectionnez une seule frame.`;
        selectionStatus.classList.add('invalid-selection');
        selectionStatus.classList.remove('valid-selection');
        generateButton.disabled = true;
      } else {
        // Aucune s√©lection
        selectionStatus.textContent = 'S√©lectionnez une frame';
        selectionStatus.classList.remove('valid-selection');
        selectionStatus.classList.remove('invalid-selection');
        generateButton.disabled = true;
      }
    }
    
    document.getElementById('generate-single-spec').addEventListener('click', () => {
      showSingleProgress();
      parent.postMessage({ 
        pluginMessage: { type: 'generate-single-spec' } 
      }, '*');
    });
    
    function showSingleProgress() {
      document.getElementById('single-progress').classList.remove('hidden');
      document.getElementById('generate-single-spec').disabled = true;
      
      // Simulation progression
      const progressFill = document.querySelector('#single-progress .progress-fill');
      let progress = 0;
      const interval = setInterval(() => {
        progress += 20;
        progressFill.style.width = progress + '%';
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('single-progress').classList.add('hidden');
            document.getElementById('generate-single-spec').disabled = false;
          }, 1000);
        }
      }, 500);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODE PROJET COMPLET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function initProjectMode() {
      resetProjectMode();
    }
    
    function resetProjectMode() {
      // R√©initialisation de l'interface
      document.getElementById('project-scan').classList.remove('hidden');
      document.getElementById('project-questions').classList.add('hidden');
      document.getElementById('project-analysis').classList.add('hidden');
      document.getElementById('project-results').classList.add('hidden');
      
      // Reset des stats
      document.getElementById('total-screens').textContent = '-';
      document.getElementById('total-pages').textContent = '-';
    }
    
    document.getElementById('scan-project').addEventListener('click', () => {
      document.getElementById('scan-project').disabled = true;
      document.getElementById('scan-project').textContent = 'üîç Scan en cours...';
      
      parent.postMessage({ 
        pluginMessage: { type: 'scan-project' } 
      }, '*');
    });
    
    document.getElementById('start-analysis').addEventListener('click', async () => {
      try {
        // Validation des champs
        const objective = document.getElementById('project-objective').value.trim();
        const users = document.getElementById('target-users').value.trim();
        
        if (!objective || !users) {
          alert('Veuillez remplir au moins l\'objectif et les utilisateurs cibles');
          return;
        }
        
        // R√©cup√©rer les donn√©es des √©crans upload√©s
        const projectData = window.projectScreensData;
        if (!projectData || !projectData.project || !projectData.project.screens || projectData.project.screens.length === 0) {
          alert('Aucune donn√©e d\'√©cran disponible. Veuillez scanner √† nouveau le projet.');
          return;
        }
        
        // Collecte du contexte business
        const businessContext = {
          project_objective: objective,
          target_users: users,
          project_type: document.getElementById('project-type').value,
          detail_level: document.getElementById('detail-level').value,
          required_integrations: document.getElementById('integrations').value || ''
        };
        
        // Transition vers analyse
        document.getElementById('project-questions').classList.add('hidden');
        document.getElementById('project-analysis').classList.remove('hidden');
        updateProgress('Envoi des donn√©es √† n8n pour analyse...');
        
        // Pr√©parer les donn√©es compl√®tes pour n8n
        const analysisData = {
          project_data: projectData.project,
          business_context: businessContext
        };
        
        // Envoyer √† n8n
        await callN8nWebhook(analysisData);
        
        // Afficher les r√©sultats
        updateProgress('‚úÖ Analyse termin√©e avec succ√®s!');
        setTimeout(() => {
          document.getElementById('project-analysis').classList.add('hidden');
          document.getElementById('project-results').classList.remove('hidden');
        }, 1000);
      } catch (error) {
        console.error('‚ùå Erreur lors de l\'analyse:', error);
        showNotification(`‚ùå Erreur: ${error.message}`, 'error');
        updateProgress('‚ùå Une erreur est survenue');
      }
    });
    
    // Configuration du client n8n
    const n8nConfig = {
      webhook_url: 'http://localhost:5678/webhook/figma-analysis',
      timeout: 60000 // 60 secondes
    };
    
    // Fonction pour appeler le webhook n8n avec gestion CORS
    async function callN8nWebhook(data) {
      console.log('üì° Envoi des donn√©es √† n8n:', data);
      showNotification('üì° Envoi des donn√©es √† n8n...', 'info');
      
      try {
        // Utiliser mode 'no-cors' pour √©viter les erreurs CORS
        let response;
        try {
          // Essayer d'abord avec mode 'cors'
          response = await fetch(n8nConfig.webhook_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
            mode: 'cors'
          });
        } catch (corsError) {
          console.warn('‚ö†Ô∏è Erreur CORS, tentative avec mode no-cors:', corsError);
          // Si erreur CORS, r√©essayer avec no-cors
          response = await fetch(n8nConfig.webhook_url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
            mode: 'no-cors'
          });
        }
        
        console.log('üì° R√©ponse n8n re√ßue:', response);
        showNotification('‚úÖ Donn√©es envoy√©es √† n8n avec succ√®s', 'success');
        
        // En mode no-cors, on ne peut pas lire la r√©ponse
        // On retourne un objet par d√©faut
        return { success: true };
      } catch (error) {
        console.error('‚ùå Erreur appel n8n:', error);
        showNotification(`‚ùå Erreur d'envoi √† n8n: ${error.message}`, 'error');
        throw error;
      }
    }
    
    // Fonction pour g√©rer les erreurs d'upload
    function handleUploadError(error) {
      console.error('Erreur lors de l\'upload de l\'image:', error);
      throw new Error('√âchec de l\'upload de l\'image. Veuillez v√©rifier votre configuration Cloudinary.');
    }
    
    // Fonction pour afficher les questions contextuelles
    function showProjectQuestions() {
      document.getElementById('project-scan').classList.add('hidden');
      document.getElementById('project-questions').classList.remove('hidden');
    }
    
    // Fonction pour afficher les r√©sultats
    function showResults(data) {
      document.getElementById('project-analysis').classList.add('hidden');
      document.getElementById('project-results').classList.remove('hidden');
      
      if (data.success) {
        // Afficher les r√©sultats
        document.getElementById('epics-count').textContent = data.epicsCount;
        document.getElementById('features-count').textContent = data.featuresCount;
        document.getElementById('stories-count').textContent = data.storiesCount;
        document.getElementById('analysis-duration').textContent = data.analysisDuration;
      } else {
        // Afficher un message d'erreur
        document.getElementById('project-results').innerHTML = `
          <div class="error-container">
            <div class="error-icon">‚ùå</div>
            <div class="error-message">${data.error}</div>
          </div>
        `;
      }
    }
    
    // Fonction pour mettre √† jour l'√©tat du bouton de g√©n√©ration en fonction de l'objectif du projet
    function updateGenerateButton() {
      const projectObjectiveElement = document.getElementById('project-objective');
      const generateButton = document.getElementById('start-analysis');
      
      // V√©rifier si les √©l√©ments existent avant d'y acc√©der
      if (!projectObjectiveElement || !generateButton) {
        return; // Sortir de la fonction si les √©l√©ments n'existent pas
      }
      
      const projectObjective = projectObjectiveElement.value.trim();
      
      if (projectObjective.length > 10) {
        generateButton.disabled = false;
        generateButton.classList.remove('btn-disabled');
        generateButton.classList.add('btn-primary');
      } else {
        generateButton.disabled = true;
        generateButton.classList.remove('btn-primary');
        generateButton.classList.add('btn-disabled');
      }
    }

    // Ajouter un √©couteur d'√©v√©nement pour le champ d'objectif du projet
    const projectObjectiveElement = document.getElementById('project-objective');
    if (projectObjectiveElement) {
      projectObjectiveElement.addEventListener('input', updateGenerateButton);
    }
    
    // Appeler la fonction une fois au chargement pour initialiser l'√©tat du bouton
    updateGenerateButton();
    
    // Initialisation
    initSingleMode();
    
    // Gestionnaire de messages du plugin Figma
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      switch (msg.type) {
        case 'selection-changed':
          if (currentMode === 'single') {
            updateSelectionStatus(msg.selection);
          }
          break;
          
        case 'upload-screens':
          // Re√ßoit les √©crans √† uploader vers Cloudinary
          handleScreensUpload(msg.screens, msg.project);
          break;
          
        case 'project-scanned':
          document.getElementById('scan-project').disabled = false;
          document.getElementById('scan-project').textContent = 'üîç Scanner le projet';
          
          // Mise √† jour des stats
          document.getElementById('total-screens').textContent = msg.data.total_screens;
          document.getElementById('total-pages').textContent = msg.data.total_pages;
          break;
          
        case 'error':
          alert(`Erreur: ${msg.message}`);
          break;
      }
    });
    
    // Fonction pour g√©rer l'upload des √©crans vers Cloudinary puis n8n
    async function handleScreensUpload(screens, project) {
      try {
        showProgress('Pr√©paration des √©crans...');
        console.log('üîç R√©ception de screens pour upload:', {
          nombre: screens.length,
          projet: project
        });
        
        // V√©rifier que nous avons bien re√ßu des √©crans
        if (!screens || screens.length === 0) {
          console.error('‚ùå Aucun √©cran re√ßu pour upload');
          showNotification('‚ùå Aucun √©cran re√ßu pour upload', 'error');
          return;
        }
        
        // Utiliser directement les valeurs par d√©faut pour Cloudinary
        const cloudName = 'du9e3f5rh'; // Valeur par d√©faut
        const uploadPreset = 'ux-specs-preset'; // Valeur par d√©faut
        
        console.log('üå©Ô∏è Configuration Cloudinary:', { cloudName, uploadPreset });
        
        // Uploader chaque √©cran vers Cloudinary
        const uploadedScreens = [];
        let successCount = 0;
        
        for (let i = 0; i < screens.length; i++) {
          const screen = screens[i];
          updateProgress(`Upload de l'√©cran ${i+1}/${screens.length}: ${screen.name}`);
          
          try {
            console.log(`üîÑ Traitement de l'√©cran ${i+1}/${screens.length}: ${screen.name}`);
            
            // V√©rifier que l'image est bien pr√©sente
            if (!screen.image) {
              console.error(`‚ùå Pas d'image pour l'√©cran ${screen.name}`);
              continue;
            }
            
            // Upload vers Cloudinary
            const cloudinaryUrl = await uploadToCloudinary(
              screen.image,
              cloudName,
              uploadPreset
            );
            
            uploadedScreens.push({
              id: screen.id,
              name: screen.name,
              page: screen.page,
              width: screen.width,
              height: screen.height,
              url: cloudinaryUrl
            });
            
            successCount++;
          } catch (error) {
            console.error(`‚ùå Erreur upload ${screen.name}:`, error);
            showNotification(`‚ùå Erreur upload ${screen.name}: ${error.message}`, 'error');
          }
        }
        
        // R√©sum√© des uploads
        console.log(`‚úÖ ${successCount}/${screens.length} √©crans upload√©s avec succ√®s`);
        showNotification(`‚úÖ ${successCount}/${screens.length} √©crans upload√©s avec succ√®s`, 'success');
        
        if (uploadedScreens.length > 0) {
          updateProgress('Pr√©paration des donn√©es pour n8n...');
          
          // Pr√©parer les donn√©es pour n8n
          const analysisData = {
            project: {
              name: project.name,
              file_key: project.file_key,
              figma_url: `https://www.figma.com/file/${project.file_key}`,
              screens: uploadedScreens
            }
          };
          
          // Stocker les donn√©es pour utilisation ult√©rieure
          window.projectScreensData = analysisData;
          
          // Passer √† l'√©tape suivante
          showProjectQuestions();
        } else {
          updateProgress('‚ùå Aucun √©cran n\'a pu √™tre upload√©');
          showNotification('‚ùå √âchec de l\'upload des √©crans', 'error');
        }
      } catch (error) {
        console.error('‚ùå Erreur globale:', error);
        showNotification(`‚ùå Erreur: ${error.message}`, 'error');
        updateProgress('‚ùå Une erreur est survenue');
      }
    }
    
    // Fonction pour uploader une image vers Cloudinary
    async function uploadToCloudinary(base64Image, cloudName, uploadPreset) {
      // V√©rifier si l'image est d√©j√† au format data:image/png;base64,...
      let imageData = base64Image;
      if (base64Image.startsWith('data:image/png;base64,')) {
        // Si c'est le cas, extraire seulement la partie base64
        imageData = base64Image.replace('data:image/png;base64,', '');
      }
      
      console.log(`üå©Ô∏è D√©but upload Cloudinary pour image (longueur: ${imageData.length})`, {
        cloudName,
        uploadPreset,
        imagePreview: imageData.substring(0, 20) + '...'
      });
      
      try {
        // Pr√©parer les donn√©es pour l'upload
        const formData = new FormData();
        formData.append('file', `data:image/png;base64,${imageData}`);
        formData.append('upload_preset', uploadPreset);
        formData.append('folder', 'figma-specs');
        
        console.log('üå©Ô∏è FormData pr√©par√©, envoi de la requ√™te √† Cloudinary...');
        
        // Faire la requ√™te vers Cloudinary
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        console.log(`üå©Ô∏è R√©ponse Cloudinary re√ßue: status=${response.status}`);
        
        if (!response.ok) {
          console.error('‚ùå √âchec upload Cloudinary:', response.status, response.statusText);
          const errorText = await response.text();
          console.error('D√©tails de l\'erreur:', errorText);
          throw new Error(`Upload failed: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Upload Cloudinary r√©ussi:', {
          url: result.secure_url,
          format: result.format,
          size: result.bytes,
          width: result.width,
          height: result.height
        });
        
        // Afficher une notification visuelle
        showNotification(`‚úÖ Image "${result.original_filename || 'sans nom'}" upload√©e avec succ√®s`, 'success');
        
        return result.secure_url;
      } catch (error) {
        console.error('‚ùå Erreur upload Cloudinary:', error);
        showNotification(`‚ùå Erreur d'upload: ${error.message}`, 'error');
        throw error;
      }
    }
    
    // Fonction pour afficher la progression
    function showProgress(message) {
      const progressElement = document.getElementById('project-analysis') || document.getElementById('project-scan');
      if (progressElement) {
        progressElement.innerHTML = `
          <div class="progress-container">
            <div class="progress-spinner"></div>
            <div class="progress-message">${message}</div>
          </div>
        `;
      }
    }
    
    // Fonction pour mettre √† jour la progression
    function updateProgress(message) {
      const messageElement = document.querySelector('.progress-message');
      if (messageElement) {
        messageElement.textContent = message;
      }
    }
    
    // Fonction pour afficher une notification
    function showNotification(message, type = 'info') {
      // Cr√©er l'√©l√©ment de notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <span>${message}</span>
        </div>
      `;
      
      // Ajouter au DOM
      const container = document.querySelector('.container');
      container.appendChild(notification);
      
      // Animation d'entr√©e
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // Supprimer apr√®s 5 secondes
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
    }
  </script>
</body>
</html>